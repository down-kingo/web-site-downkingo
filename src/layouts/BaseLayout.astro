---
import '../styles/global.css';
import { SEO } from 'astro-seo';
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';
import { ViewTransitions } from 'astro:transitions';

interface Props {
	title: string;
	description: string;
	lang?: string;
	canonical?: string;
	opengraph?: any;
    twitter?: any;
    keywords?: string;
    alternateUrls?: { en?: string; pt?: string };
    currentPage?: 'home' | 'download' | 'roadmap' | 'docs' | 'online' | 'blog';
}

const { title, description, lang = "pt-BR", canonical, opengraph, twitter, keywords, alternateUrls, currentPage = "home" } = Astro.props;

const language = lang === "pt-BR" || lang === "pt" ? "pt" : "en";
const ogLocale = language === "pt" ? "pt_BR" : "en_US";

// Hreflang logic
const currentPath = Astro.url.pathname;
const isPt = language === "pt";
// Strict canonical domain without trailing slash initially
const baseUrl = "https://downkingo.com";

// Helper to ensure trailing slash
const ensureSlash = (url: string) => url.endsWith('/') ? url : `${url}/`;

// Build alternate URLs
let enUrl: string;
let ptUrl: string;

if (alternateUrls) {
  // Manual override for pages with different slugs (e.g. /tools â†” /pt/ferramentas)
  enUrl = alternateUrls.en ? baseUrl + alternateUrls.en : baseUrl + currentPath;
  ptUrl = alternateUrls.pt ? baseUrl + alternateUrls.pt : baseUrl + currentPath;
} else if (isPt) {
  // PT page: replace /pt/ prefix with /en/ for EN alternate
  // Handle root /pt/ specifically to avoid double slash issues or bad replace
  const cleanPath = currentPath.replace(/\/$/, ""); // Strip trailing slash for processing
  const pathWithoutLang = cleanPath.replace(/^\/pt/, "") || ""; // Remove /pt
  
  // Construct new paths
  enUrl = baseUrl + (pathWithoutLang ? `/en${pathWithoutLang}` : "/"); // Default to root if empty
  if (pathWithoutLang && !pathWithoutLang.startsWith('/')) enUrl = baseUrl + `/en/${pathWithoutLang}`; // Safety check
  
  // Actually simplest way is regex if path structure is consistent:
  // /pt/foo -> /en/foo
  enUrl = baseUrl + currentPath.replace(/^\/pt\//, "/en/").replace(/^\/pt$/, "/"); 
  ptUrl = baseUrl + currentPath;
} else {
  // EN page: replace /en/ prefix with /pt/ for PT alternate
  // If we are at root /, currentPath is "/"
  if (currentPath === "/" || currentPath === "") {
      enUrl = baseUrl + "/";
      ptUrl = baseUrl + "/pt/";
  } else {
      enUrl = baseUrl + currentPath;
      ptUrl = baseUrl + currentPath.replace(/^\/en\//, "/pt/");
      // Handle case where path is just /en/ (if that ever happens)
      if (currentPath === "/en/" || currentPath === "/en") {
          ptUrl = baseUrl + "/pt/";
      } else if (!currentPath.startsWith('/en/')) {
         // Page at root like /docs -> /pt/docs (assuming simple mapping, or no mapping?)
         // If generic page, assume direct mapping
         ptUrl = baseUrl + "/pt" + currentPath;
      }
  }
}

// Ensure trailing slashes for Hreflang to match Canonical standard
enUrl = ensureSlash(enUrl);
ptUrl = ensureSlash(ptUrl);

// Merge twitter defaults
const twitterConfig = {
  card: "summary_large_image" as const,
  site: "@EMANUELSOARES71",
  creator: "@EMANUELSOARES71",
  ...twitter
};
---

<!DOCTYPE html>
<html lang={lang} class="scroll-smooth selection:bg-primary/30 selection:text-white">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content={Astro.generator} />
    
    <!-- Console Filter -->
    <script is:inline src="/scripts/console-filter.js"></script>
    
    <SEO
      title={title}
      description={description}
      canonical={canonical}
      openGraph={opengraph}
      twitter={twitterConfig}
      extend={{
        meta: [
          { name: "keywords", content: keywords },
          { name: "theme-color", content: "#050505" },
          { name: "robots", content: "index, follow, max-image-preview:large" },
          { property: "og:locale", content: ogLocale },
        ],
        link: [
          { rel: "icon", type: "image/x-icon", href: "/icon.ico?v=2" }
        ]
      }}
    />

    <!-- Fonts -->
    <link rel="preload" href="/fonts/inter-900.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/inter-400.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/jetbrains-mono-400.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/jetbrains-mono-500.woff2" as="font" type="font/woff2" crossorigin>

    <!-- Hreflang Tags -->
    <link rel="alternate" hreflang="en" href={enUrl} />
    <link rel="alternate" hreflang="pt-BR" href={ptUrl} />
    <link rel="alternate" hreflang="x-default" href={enUrl} />

    <ViewTransitions />
    <slot name="head" />

    <script type="text/partytown" defer data-domain="downkingo.com" src="https://plausible.io/js/script.js"></script>
</head>
<body class="bg-page text-swiss antialiased overflow-x-hidden relative" id="body">
    <Navigation lang={language} currentPage={currentPage} />

    <main class="relative z-10 w-full overflow-hidden">
        <slot />
    </main>

    <Footer lang={language} />

    <slot name="scripts" />

    <script is:inline>
        // Smooth Mouse Follower Global
        document.addEventListener('mousemove', (e) => {
            const x = e.clientX;
            const y = e.clientY;
            
            const spotlight = document.getElementById('spotlight');
            if(spotlight) {
                spotlight.style.setProperty('--x', `${x}px`);
                spotlight.style.setProperty('--y', `${y}px`);
            }
        });

        // Intersection Observer for Reveal Global
        const observerOptions = {
            threshold: 0.1,
            rootMargin: "0px"
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                    observer.unobserve(entry.target);
                }
            });
        }, observerOptions);

        document.querySelectorAll('.reveal-wrapper').forEach(el => observer.observe(el));
    </script>
</body>
</html>
